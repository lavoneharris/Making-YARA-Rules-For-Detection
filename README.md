<h1>Making Yara Rules for Detection Lab</h1>


<h2>Description</h2>



<br />


<h2>What are YARA Rules:</h2>





<br />

<h2>Why are YARA Rules Important:</h2>

<h2>Utilities Used:</h2>
- Oracle Virtual Box <br>
- Linux Terminal <br>





<h2>Environments Used </h2>
- Windows 10 <br>
- Kali Linux

<h2> Instructions:</h2>
<p align="center">
 1. We will need to download YARA on our Linux VM. Begin by downloading the .tar.gz file from the YARA github Link: https://github.com/virustotal/yara/releases/tag/v4.0.2. <br>
  Note: Make sure that this file is downloaded on the Kali Linux VM
<br/>
<img src="https://imgur.com/T1Aosof.png" height="80%" width="80%" alt="Download Windows 10 ISO File"/>
<br />
<br />
2. Once the .tar.gz file has been downloaded we will need to install it via Terminal. <br> 
  Use command:<br> sudo -i <br>
               sudo apt-get install automake libtool make gcc pkg-config
  <br/>
<img src="https://imgur.com/T1Aosof.png" height="80%" width="80%" alt="Download Windows 10 ISO File"/>
<br />
<br />
 3. Now run commandsin the following order. <br>
  Use Commands:<br> 
 tar -zxf yara-4.0.2.tar.gz  <br>
                cd yara-4.0.2/  <br>
               ./bootstrap.sh  <br>
 <img src="https://imgur.com/T1Aosof.png" height="80%" width="80%" alt="Download Windows 10 ISO File"/>
<br />
<br />
 4. Next we will need compile and install with these 3 commands. <br>
  Use Commands: <br>
                    ./configure <br>
                      make <br>
                sudo make install <br>
  <img src="https://imgur.com/T1Aosof.png" height="80%" width="80%" alt="Download Windows 10 ISO File"/>
<br />
<br />
5. To ensure everything is installed properly we we will run the following command. <br>
  Use Command:<br>
 make check <br>
  If everything installed properly everything should pass like the image below. <br>
  <img src="https://imgur.com/T1Aosof.png" height="80%" width="80%" alt="Download Windows 10 ISO File"/>
<br />
<br />
 <h2> Writing Yara Rules Instructions:</h2>
<p align="center">


 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 YarGen is a python tool that allows us to automatically generate rules for malicious files, and can save us a lot of time, and prevent human errors when writing rules. We’re going to walk you through installing YarGen, and how to use it. You’ll be doing this in the next threat hunting activity, so make sure you have it installed on your Kali Linux virtual machine!

If you run into any issues with yargen or its dependencies, try using the python3 and pip3 commands instead of python and pip.

First, we need to open the following webpage in our Kali machine, go to the releases page, and scroll to the bottom so we can download the .tar.gz file – https://github.com/Neo23x0/yarGen/releases
 
 
 Then we need to open a terminal in the location of the downloaded .tar.gz file, and the run the following command to extract YarGen: tar -zxf yarGen-0.18.0.tar.gz. Next we need to use pip to download and install some additional dependencies. Try running the command pip in a terminal. If it states that the command is not found then you need to install python-pip using the command sudo apt-get install python-pip. Now execute the following two commands:

sudo pip install pefile cd
sudo pip install scandir lxml naiveBayesClassifier
Now use cd to move into the extracted YarGen directory, and run the following command to ensure everything is updated: python yarGen.py --update. Great, everything is ready. We can now type the command python yarGen.py --help to see the available options for generating rules with this tool.
 
 
 
 
 The flags we’re interested in are -m which allows us to define the path to the file or files we want to generate rules from, and -o which allows us to define the name and path of the rules generated by YarGen. Let’s test it out on a malicious .exe file. The command we want to execute is: python yarGen.py -m /root/Desktop/Malware -o ./TestRule.yara

python yarGen.py – Runs the yarGen python script (we need to be in the same directory as this file, or provide the file path to yarGen.py)
-m /root/Desktop/Malware – Create rules for files inside the Malware folder on the Desktop of our current user, root
-o ./TestRule.yara – Output the generated rule to the current folder of the terminal (./) in our case, the yarGen folder, and name the file TestRule.yara
 
 It took about 3 minutes for the rule to be generated in our lab. Once we saw the “All rules written” message we used CTRL + C to exit, then used the following command to read the rule from the terminal: cat TestRule.yara. Let’s take a look at what was generated!
 
 The above rule has selected a number of strings from the binary (wallpaperHD.exe) and the condition also includes the file size and the file hash. Due to how the condition is written, the rule is able to look for a combination of all the indicators of compromise (IOCs) we have pulled from the file, and we could now import this YARA rule into our endpoint detection and response platform (EDR) to use this for detection on a large scale.
